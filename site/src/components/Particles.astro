---
interface Props {
  count?: number;
  class?: string;
}

const { count = 150, class: className = '' } = Astro.props;
---

<canvas class={`particles-canvas ${className}`} data-count={count}></canvas>

<script>
  const canvas = document.querySelector<HTMLCanvasElement>('.particles-canvas');
  if (!canvas) throw new Error('No canvas');

  const ctx = canvas.getContext('2d')!;
  const count = Number(canvas.dataset.count) || 150;
  const dpr = Math.min(window.devicePixelRatio, 2);

  const colors = ['#87afd7', '#af87af', '#87afaf', '#d7afaf'];

  interface Particle {
    x: number; y: number; z: number;
    vx: number; vy: number; vz: number;
    color: string; size: number;
  }

  let w = 0, h = 0;
  const particles: Particle[] = [];
  const mouse = { x: -9999, y: -9999 };

  function resize() {
    const rect = canvas!.getBoundingClientRect();
    w = rect.width;
    h = rect.height;
    canvas!.width = w * dpr;
    canvas!.height = h * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function init() {
    resize();
    particles.length = 0;
    for (let i = 0; i < count; i++) {
      const r = Math.random();
      const size = r < 0.08 ? Math.random() * 3 + 2
                 : r < 0.25 ? Math.random() * 2 + 1
                 : Math.random() * 1 + 0.5;
      particles.push({
        x: Math.random() * w,
        y: Math.random() * h,
        z: Math.random(),
        vx: (Math.random() - 0.5) * 0.3,
        vy: (Math.random() - 0.5) * 0.3,
        vz: (Math.random() - 0.5) * 0.001,
        color: colors[Math.floor(Math.random() * colors.length)],
        size,
      });
    }
  }

  let time = 0;
  function frame() {
    time += 0.016;
    ctx.clearRect(0, 0, w, h);

    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];

      // Drift + wobble
      p.x += p.vx + Math.sin(time * 0.6 + i * 0.1) * 0.08;
      p.y += p.vy + Math.cos(time * 0.4 + i * 0.1) * 0.08;
      p.z += p.vz;
      if (p.z < 0) p.z = 1;
      if (p.z > 1) p.z = 0;

      // Mouse attraction
      const dx = mouse.x - p.x;
      const dy = mouse.y - p.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 200 && dist > 0) {
        const force = 0.015;
        p.x += dx / dist * force * (200 - dist) * 0.1;
        p.y += dy / dist * force * (200 - dist) * 0.1;
      }

      // Wrap
      if (p.x > w + 10) p.x = -10;
      if (p.x < -10) p.x = w + 10;
      if (p.y > h + 10) p.y = -10;
      if (p.y < -10) p.y = h + 10;

      // Draw
      const depth = 0.3 + p.z * 0.7;
      const alpha = 0.15 + depth * 0.35;
      const r = p.size * depth;

      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
      ctx.fillStyle = p.color;
      ctx.globalAlpha = alpha;
      ctx.fill();
    }

    ctx.globalAlpha = 1;
    requestAnimationFrame(frame);
  }

  window.addEventListener('resize', resize);
  window.addEventListener('mousemove', (e) => {
    const rect = canvas!.getBoundingClientRect();
    mouse.x = e.clientX - rect.left;
    mouse.y = e.clientY - rect.top;
  });

  init();
  requestAnimationFrame(frame);
</script>

<style>
  .particles-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
</style>
